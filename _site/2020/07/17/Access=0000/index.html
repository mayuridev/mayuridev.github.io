<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Access=0000 &middot; The Haven
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="//public/css/poole.css ">
  <link rel="stylesheet" href="//public/css/syntax.css ">
  <link rel="stylesheet" href="//public/css/hyde.css ">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  <!--<link rel="stylesheet" href="//public/css/syntax.css ">
  <link rel="stylesheet" href="//public/css/hyde.css ">-->
</head>


  <body>
    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          The Haven
        </a>
      </h1>
      <p class="lead">a journal of thoughts</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/allposts">All Posts</a>
        <a style="text-indent: 10px" class="sidebar-nav-item" href="/cybersec">CyberSecurity</a>
        <a style="text-indent: 10px" class="sidebar-nav-item" href="/misc">Miscellaneous</a>
      <a class="sidebar-nav-item" href="https://dylaniskandar.com">About Me</a>
    </nav>

    <p>&copy; 2020 Dylan Iskandar.</p>
  </div>
</div>

    <div class="content container">
      <div class="post">
  <h1 class="post-title">Access=0000</h1>
  <span class="post-date">17 Jul 2020</span>
  <p>This is a writeup for a crypto challenge in <a href="https://ractf.co.uk/">RACTF</a> 2020, where <a href="https://rgbsec.org">we</a> placed 6th.</p>

<h3 id="challenge-description">Challenge Description:</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Challenge instance ready at 95.216.233.106:57735

We found a strange service, it looks like you can generate an access token for the network service, but you shouldn't be able to read the flag... We think.
</code></pre></div></div>
<h3 id="solving-">Solving :</h3>

<p>We are given <a href="https://pastebin.com/3e9ryfvf">access.py</a>. Lets take a look the server file to see what the program does.</p>

<p>From the top, we see that <code class="language-plaintext highlighter-rouge">get_flag</code>: 
<!--more--></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def get_flag(token, iv):
    token = bytes.fromhex(token)
    iv = bytes.fromhex(iv)
    try:
        cipher = AES.new(KEY, AES.MODE_CBC, iv)
        decrypted = cipher.decrypt(token)
        unpadded = unpad(decrypted, 16)
    except ValueError as e:
        return {"error": str(e)}
    if b"access=0000" in unpadded:
        return {"flag": FLAG}
    else:
        return {"error": "not authorized to read flag"}
</code></pre></div></div>

<p>1) converts <code class="language-plaintext highlighter-rouge">token</code> and <code class="language-plaintext highlighter-rouge">iv</code> to their representation as “bytes”</p>

<p>2) tries to decrypt <code class="language-plaintext highlighter-rouge">token</code> with the given <code class="language-plaintext highlighter-rouge">key</code> and <code class="language-plaintext highlighter-rouge">iv</code></p>

<p>3) if the string <code class="language-plaintext highlighter-rouge">access=0000</code> is in the message, then it will return the flag</p>

<p>4) if the string <code class="language-plaintext highlighter-rouge">access=0000</code> is not in the message, else print <code class="language-plaintext highlighter-rouge">not authorized to read flag</code></p>

<p>Below that is <code class="language-plaintext highlighter-rouge">generate_token</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def generate_token():
    expires_at = (datetime.today() + timedelta(days=1)).strftime("%s")
    token = f"access=9999;expiry={expires_at}".encode()
    iv = get_random_bytes(16)
    padded = pad(token, 16)
    cipher = AES.new(KEY, AES.MODE_CBC, iv)
    encrypted = cipher.encrypt(padded)
    ciphertext = iv.hex() + encrypted.hex()
    return {"token": ciphertext}
</code></pre></div></div>

<p>1) creates an expiration date</p>

<p>2) generates a token string with <code class="language-plaintext highlighter-rouge">access=9999</code> (defined with guest + token expire time)</p>

<p>3) generates a random <code class="language-plaintext highlighter-rouge">iv</code></p>

<p>4) pads <code class="language-plaintext highlighter-rouge">token</code> to the AES block size</p>

<p>5) creates a new AES cipher instance</p>

<p>6) encrypts the padded <code class="language-plaintext highlighter-rouge">token</code></p>

<p>7) generates the cipher text as a result of <code class="language-plaintext highlighter-rouge">iv.hex()</code> and <code class="language-plaintext highlighter-rouge">encrypted.hex()</code></p>

<p>8) returns the ciphertext</p>

<p>As we can see, the goal of this challenge  is to retrieve the flag by generating a guest token = <code class="language-plaintext highlighter-rouge">access=9999</code> and forge an admin token = <code class="language-plaintext highlighter-rouge">access=0000</code>. As we can see from <code class="language-plaintext highlighter-rouge">generate_token()</code>, guest tokens are generatated with an AES-CBC mode encryption of <code class="language-plaintext highlighter-rouge">access=9999;expiry={expires_at}</code>. In the AES-CBC mode, the stream is split into 16-byte blocks, with each block encrypted with AES. Then the result is sent to output and XORed with the next block before it gets encrypted.</p>

<p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/80/CBC_encryption.svg/1920px-CBC_encryption.svg.png" alt="Here is a depiction of CBC mode encryption." /></p>

<p>The ciphertext (the result of the encryption) is = <code class="language-plaintext highlighter-rouge">c[i] = AES_Enc(c[i-1] XOR m[i])</code> with <code class="language-plaintext highlighter-rouge">c[0]</code> being <code class="language-plaintext highlighter-rouge">iv</code>. If we want to decrypt the ciphertext, we can use the following formula = <code class="language-plaintext highlighter-rouge">m[i] = AES_Dec(c[i]) XOR c[i-1]</code></p>

<h3 id="solve-script-">Solve Script :</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>token = '3913er43j134h6d4fk81df97h4812df315dfd978g62fuehf38173g7eba445g9833kj1371637h26hfa3khuy3j5vx948d0'
token = bytes.fromhex(token)

iv = token[:16]
ct = token[16:]

for i in range(7,11):
    iv = iv[:i] + bytes([(iv[i] ^ ord('0') ^ ord('9'))]) + iv[i+1:]

print(iv.hex())
print(ct.hex())
</code></pre></div></div>

<p>This script replaces <code class="language-plaintext highlighter-rouge">iv</code> with <code class="language-plaintext highlighter-rouge">iv XOR D</code>, so the first block of the plaintext will be decoded as <code class="language-plaintext highlighter-rouge">m[0] XOR D</code>. We can XOR our <code class="language-plaintext highlighter-rouge">iv</code> to change the guest token (<code class="language-plaintext highlighter-rouge">access=9999</code>) to the admin token (<code class="language-plaintext highlighter-rouge">access=0000</code>).</p>

<p>Flag: <strong>ractf{cbc_b17_fl1pp1n6_F7W!}</strong></p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2021/04/24/CryptoGolf/">
            CryptoGolf
            <small>24 Apr 2021</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/08/16/Analysis-Incarnate2/">
            Analysis Incarnate 2
            <small>16 Aug 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/08/15/Analysis-Incarnate/">
            Analysis Incarnate
            <small>15 Aug 2020</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>


<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    }
  };
  </script>
  <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
  </script>
    </div>

  </body>
</html>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    }
  };
  </script>
  <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
  </script>